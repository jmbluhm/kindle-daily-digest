generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id        String    @id @default(cuid())
  email     String?   @unique
  createdAt DateTime  @default(now())

  articles   Article[]
  digestRuns DigestRun[]
}

enum ArticleStatus {
  INBOX
  ARCHIVED
}

model Article {
  id             String        @id @default(cuid())
  userId         String
  url            String
  canonicalUrl   String
  title          String
  author         String?
  siteName       String?
  publishedAt    DateTime?
  excerpt        String?
  contentHtml    String
  contentText    String
  wordCount      Int
  readingMinutes Int
  status         ArticleStatus @default(INBOX)
  favorited      Boolean       @default(false)
  contentHash    String
  sentToKindleAt DateTime?
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt

  user User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  tags ArticleTag[]

  @@unique([userId, contentHash])
  @@index([userId, status])
  @@index([userId, sentToKindleAt])
}

model Tag {
  id        String       @id @default(cuid())
  name      String       @unique
  createdAt DateTime     @default(now())

  articles ArticleTag[]
}

model ArticleTag {
  articleId String
  tagId     String

  article Article @relation(fields: [articleId], references: [id], onDelete: Cascade)
  tag     Tag     @relation(fields: [tagId], references: [id], onDelete: Cascade)

  @@id([articleId, tagId])
}

enum DigestStatus {
  SUCCESS
  FAILED
}

model DigestRun {
  id                  String       @id @default(cuid())
  userId              String
  startedAt           DateTime     @default(now())
  finishedAt          DateTime?
  status              DigestStatus @default(SUCCESS)
  includedArticleIds  Json         @default("[]")
  feedItemsIncluded   Json         @default("[]")
  epubFilename        String?
  emailMessageId      String?
  error               String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, startedAt])
}
