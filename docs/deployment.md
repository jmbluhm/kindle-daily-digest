# Deployment Guide

## Render Deployment

### Prerequisites

1. A [Render](https://render.com) account
2. A [Resend](https://resend.com) account with verified domain
3. Your Kindle email address

### Setup Steps

#### 1. Fork or Clone Repository

Fork this repository to your GitHub account, or push it to a new private repo.

#### 2. Create Render Blueprint

1. Go to Render Dashboard
2. Click "New +" â†’ "Blueprint"
3. Connect your GitHub repository
4. Render will detect `render.yaml` and show the services to create

#### 3. Configure Environment Variables

Before deploying, set these environment variables in Render:

**For both services (API and Cron):**

| Variable | Value |
|----------|-------|
| `ADMIN_API_KEY` | A secure random string (32+ chars) |
| `ADMIN_PASSWORD` | Your admin login password |
| `RESEND_API_KEY` | From Resend dashboard |
| `EMAIL_FROM` | Your verified sender email |
| `KINDLE_EMAIL_TO` | Your Kindle email(s), comma-separated |
| `RSS_FEEDS` | Comma-separated RSS feed URLs |
| `DIGEST_INTERESTS_JSON` | Your interests JSON (see below) |

**Auto-generated:**
- `DATABASE_URL` - Automatically linked to Render Postgres
- `SESSION_SECRET` - Auto-generated by Render

#### 4. Deploy

Click "Apply" to create all services. Render will:

1. Create a PostgreSQL database
2. Build and deploy the API service
3. Create the cron job (runs daily at 6 AM Mountain Time)

#### 5. Initial Setup

After deployment:

1. Visit your API URL (e.g., `https://kindle-assist-api.onrender.com`)
2. Log in with your `ADMIN_PASSWORD`
3. The admin user is created automatically on first login

### Cron Schedule

The digest cron is set to run at `0 13 * * *` (1 PM UTC = 6 AM Mountain Time).

To change the schedule, edit `render.yaml`:

```yaml
schedule: "0 14 * * *"  # 7 AM Mountain Time
```

Common schedules:
- `0 12 * * *` - 5 AM MT (winter) / 6 AM MT (summer)
- `0 13 * * *` - 6 AM MT (winter) / 7 AM MT (summer)
- `0 14 * * *` - 7 AM MT (winter) / 8 AM MT (summer)

### Environment Variable: DIGEST_INTERESTS_JSON

This must be valid JSON. Example for Render:

```json
{"apple":{"keywords":["apple","iphone","mac"]},"ai":{"keywords":["llm","gpt","claude"]}}
```

Note: Render may require this as a single line without extra whitespace.

## Manual Deployment

If not using Render Blueprint, deploy manually:

### Database

1. Create a PostgreSQL database
2. Set `DATABASE_URL` environment variable

### API Service

```bash
# Build
pnpm install
pnpm db:generate
pnpm build

# Run migrations
pnpm db:migrate:deploy

# Start
node apps/api/dist/index.js
```

### Cron Job

Set up a system cron or scheduled task:

```bash
# Build (same as API)
pnpm install
pnpm db:generate
pnpm build

# Run daily
node apps/cron/dist/index.js
```

Example crontab entry:
```
0 6 * * * cd /path/to/kindle-assist && node apps/cron/dist/index.js >> /var/log/kindle-digest.log 2>&1
```

## Troubleshooting

### Deployment Fails

1. Check Render build logs for errors
2. Ensure all required environment variables are set
3. Verify DATABASE_URL is connected

### Digest Not Sending

1. Check cron job logs in Render
2. Verify Resend API key is valid
3. Ensure EMAIL_FROM domain is verified in Resend
4. Confirm KINDLE_EMAIL_TO is whitelisted in Amazon Kindle settings

### No Articles in Digest

1. Check if you have unsent inbox articles
2. Verify RSS_FEEDS URLs are accessible
3. Check DIGEST_INTERESTS_JSON is valid JSON
4. Review cron logs for RSS fetch errors

## Monitoring

### Health Check

The API exposes `/healthz` endpoint:

```bash
curl https://your-api.onrender.com/healthz
```

### Digest Run History

View past digest runs via API:

```bash
curl https://your-api.onrender.com/api/digest/runs \
  -H "x-api-key: YOUR_API_KEY"
```

Or in the Render dashboard, view cron job execution history.
